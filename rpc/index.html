<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>RPC - Kamodo Analysis Suite</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  <link href="../css/ansi-colours.css" rel="stylesheet" />
  <link href="../css/jupyter-cells.css" rel="stylesheet" />
  <link href="../css/pandas-dataframe.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "RPC";
    var mkdocs_page_input_path = "rpc.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Kamodo Analysis Suite</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/Kamodo/">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/Visualization/">Visualization</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/Syntax/">Syntax</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/Kamodofying_Models/">Kamodofying Models</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../notebooks/FieldIntegration/">Field Integration</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">RPC</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#configuring-a-kamodo-server">Configuring a Kamodo server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#starting-an-kamodo-server">Starting an Kamodo server</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#starting-a-client">Starting a client</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../API/">API</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING/">Contributing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../additional_resources/">Additional Resources</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Kamodo Analysis Suite</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>RPC</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="rpc">RPC<a class="headerlink" href="#rpc" title="Permanent link">&para;</a></h1>
<p>Kamodo includes a Remote Call Procedure (RPC) interface, based on <a href="https://capnproto.org/">capnproto</a>. This allows Kamodo objects to both serve and connect to other kamodo functions hosted on external servers.</p>
<p>We can test this functionality using <a href="https://docs.docker.com/compose/">docker compose</a> (See the <code>docker-compose.yaml</code> file in the base of this repo).</p>
<p>Our docker-compose configuration contains two services we can use to test this functionality:</p>
<ul>
<li>kamodo-rpc-py37 (runs kamodo-core with python 3.7)</li>
<li>kamodo-rpc-py38 (runs kamodo-core with python 3.8)</li>
</ul>
<p>Here are the corresponding definitions in <code>docker-compose.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>  <span class="nt">kamodo-rpc-py37</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dockerfiles/kamodo-rpc-py37.Dockerfile</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bind</span>
        <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}</span>
        <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/kamodo-core</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;60001:60000&quot;</span>
  <span class="nt">kamodo-rpc-py38</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dockerfiles/kamodo-rpc-py38.Dockerfile</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bind</span>
        <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}</span>
        <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/kamodo-core</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;60000:60000&quot;</span>
    <span class="nt">command</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kamodo-rpc</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">rpc_conf=kamodo/rpc/kamodo_rpc_test.yaml</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host=0.0.0.0</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port=&#39;60000&#39;</span>
</code></pre></div>

<p>Either one will mount the base of the repo into the corresponding container at run time. Note that <code>kamodo-rpc-py37</code> will use port <code>60001</code>.</p>
<h2 id="configuring-a-kamodo-server">Configuring a Kamodo server<a class="headerlink" href="#configuring-a-kamodo-server" title="Permanent link">&para;</a></h2>
<p>To configure a Kamodo server, create a <code>kamodo_rpc.yaml</code> file. A simple example is given in the root of the kamodo-core repo:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">!Kamodo</span>
<span class="nt">f</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">x**2 - x -1</span>
</code></pre></div>

<p>The <code>!Kamodo</code> line informs our yaml parser that the next line defines a kamodo object with the following key-value pairs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The kamodo specification file is under rapid development</p>
</div>
<!-- #region -->
<h2 id="starting-an-kamodo-server">Starting an Kamodo server<a class="headerlink" href="#starting-an-kamodo-server" title="Permanent link">&para;</a></h2>
<p>To build a container compatible with python <code>3.7</code>, run</p>
<div class="codehilite"><pre><span></span><code>docker compose build kamodo-rpc-py37
</code></pre></div>

<p>This will pull the latest version of <code>kamodo-core</code> and build it inside a container ready for deployment. Feel free to build on top of the resulting image.</p>
<p>Next, start the container with:</p>
<div class="codehilite"><pre><span></span><code>docker compose up kamodo-rpc-py37
</code></pre></div>

<details>
    <summary> Click to expand console output

    </summary>

<div class="codehilite"><pre><span></span><code><span class="go">[+] Running 1/0</span>
<span class="go"> ⠿ Container kamodo-core-kamodo-rpc-py37-1  Created                                                                     0.0s</span>
<span class="go">Attaching to kamodo-core-kamodo-rpc-py37-1</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | {&#39;rpc_conf&#39;: &#39;kamodo/rpc/kamodo_rpc_test.yaml&#39;, &#39;host&#39;: &#39;0.0.0.0&#39;, &#39;port&#39;: &#39;60000&#39;}</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | serving   arg_units lhs           rhs symbol units</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | f        {}   f  x**2 - x - 1   f(x)      </span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | certfile not supplied</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | keyfile not supplied</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | using default certificate</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | Using selfsigned cert from: selfsigned.cert</span>
<span class="go">kamodo-core-kamodo-rpc-py37-1  | [2022-05-04 22:23:23,543][rpc.proto][DEBUG] - Try IPv4</span>
</code></pre></div>


</details>

<p>At startup, the container automatically generates an SSL key and certificate (when one is not already present). </p>
<h2 id="starting-a-client">Starting a client<a class="headerlink" href="#starting-a-client" title="Permanent link">&para;</a></h2>
<p>Since the root of the repo is mapped into the container, we can access the cert from the host <code>selfsigned.cert</code>.</p>
<p>Open a separate terminal and connect to the container from your host system (use the same directory where <code>selfsigned.cert</code> i.e. the root of the mounted kamodo-core repo):</p>
<div class="codehilite"><pre><span></span><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">kamodo</span> <span class="kn">import</span> <span class="n">KamodoClient</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">k</span> <span class="o">=</span> <span class="n">KamodoClient</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">60001</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">k</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> 
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">19</span> <span class="c1"># (5)**2-(5)-1</span>
</code></pre></div>

<!-- #endregion -->

<!-- #region -->
<h1 id="rpc-spec">RPC Spec<a class="headerlink" href="#rpc-spec" title="Permanent link">&para;</a></h1>
<p>Kamodo uses capnproto to communicate binary data between functions hosted on different systems. This avoids the need for json serialization and allows for server-side function pipelining while minimizing data transfers.</p>
<p>Kamodo's RPC specification file is located in <code>kamodo/rpc/kamodo.capnp</code>:</p>
<div class="codehilite"><pre><span></span><code>@0xbfd16a03c247aaa9<span class="p">;</span>


interface Kamodo <span class="o">{</span>
  struct Map<span class="o">(</span>Key, Value<span class="o">)</span> <span class="o">{</span>
    entries @0 :List<span class="o">(</span>Entry<span class="o">)</span><span class="p">;</span>
    struct Entry <span class="o">{</span>
      key @0 :Key<span class="p">;</span>
      value @1 :Value<span class="p">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  getFields @0 <span class="o">()</span> -&gt; <span class="o">(</span>fields :Map<span class="o">(</span>Text, Field<span class="o">))</span><span class="p">;</span>

  getMath @1 <span class="o">()</span> -&gt; <span class="o">(</span>math :Map<span class="o">(</span>Text, Function<span class="o">))</span><span class="p">;</span>

  evaluate @2 <span class="o">(</span>expression: Expression<span class="o">)</span> -&gt; <span class="o">(</span>value: Value<span class="o">)</span><span class="p">;</span>

  interface Value <span class="o">{</span>
    <span class="c1"># Wraps a numeric value in an RPC object.  This allows the value</span>
    <span class="c1"># to be used in subsequent evaluate() requests without the client</span>
    <span class="c1"># waiting for the evaluate() that returns the Value to finish.</span>

    <span class="nb">read</span> @0 <span class="o">()</span> -&gt; <span class="o">(</span>value :Literal<span class="o">)</span><span class="p">;</span>
    <span class="c1"># Read back the raw numeric value.</span>
  <span class="o">}</span>

  struct Expression <span class="o">{</span>
    <span class="c1"># A numeric expression.</span>

    union <span class="o">{</span>
      literal @0 :Literal<span class="p">;</span>
      <span class="c1"># A literal numeric value.</span>

      store @1 :Value<span class="p">;</span>
      <span class="c1"># A value that was (or, will be) returned by a previous</span>
      <span class="c1"># evaluate().</span>

      parameter @2 :UInt32<span class="p">;</span>
      <span class="c1"># A parameter to the function (only valid in function bodies;</span>
      <span class="c1"># see defFunction).</span>

      call :group <span class="o">{</span>
        <span class="c1"># Call a function on a list of parameters.</span>
        <span class="k">function</span> @3 :Function<span class="p">;</span>
        params @4 :List<span class="o">(</span>Expression<span class="o">)</span><span class="p">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="c1"># Void: Void</span>
<span class="c1"># Boolean: Bool</span>
<span class="c1"># Integers: Int8, Int16, Int32, Int64</span>
<span class="c1"># Unsigned integers: UInt8, UInt16, UInt32, UInt64</span>
<span class="c1"># Floating-point: Float32, Float64</span>
<span class="c1"># Blobs: Text, Data</span>
<span class="c1"># Lists: List(T)</span>


  struct Literal <span class="o">{</span>
    union <span class="o">{</span>
      void @0 :Void<span class="p">;</span>
      bool @1 :Bool<span class="p">;</span>
      int8 @2 :Int8<span class="p">;</span>
      int16 @3 :Int16<span class="p">;</span>
      int32 @4 :Int32<span class="p">;</span>
      int64 @5 :Int64<span class="p">;</span>
      uint8 @6 :UInt8<span class="p">;</span>
      uint16 @7 :UInt16<span class="p">;</span>
      uint32 @8 :UInt32<span class="p">;</span>
      uint64 @9 :UInt64<span class="p">;</span>
      float32 @10 :Float32<span class="p">;</span>
      float64 @11 :Float64<span class="p">;</span>
      text @12 :Text<span class="p">;</span>
      data @13 :Data<span class="p">;</span>
      list @14 :List<span class="o">(</span>Literal<span class="o">)</span><span class="p">;</span>
      array @15 :Array<span class="p">;</span>
      int @16 :Text<span class="p">;</span>
      listint64 @17 :List<span class="o">(</span>Int64<span class="o">)</span><span class="p">;</span>
      listfloat64 @18 :List<span class="o">(</span>Float64<span class="o">)</span><span class="p">;</span>
      rational @19 :Rational<span class="p">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  struct Rational <span class="o">{</span>
    p @0 :Int64<span class="p">;</span>
    q @1 :Int64<span class="p">;</span>
  <span class="o">}</span>


  <span class="c1"># everything needed for registration</span>
  struct Field <span class="o">{</span>
    func @0 :Function<span class="p">;</span>
    meta @1 :Meta<span class="p">;</span>
    data @2 :Array<span class="p">;</span>
  <span class="o">}</span>

  <span class="c1"># match kamodo&#39;s meta attribute</span>
  struct Meta <span class="o">{</span>
    units @0 :Text<span class="p">;</span>
    argUnits @1 :Map<span class="o">(</span>Text, Text<span class="o">)</span><span class="p">;</span>
    citation @2 :Text<span class="p">;</span>
    equation @3 :Text<span class="p">;</span> <span class="c1"># latex expression</span>
    hiddenArgs @4 :List<span class="o">(</span>Text<span class="o">)</span><span class="p">;</span>
  <span class="o">}</span>

  struct Argument <span class="o">{</span>
    name @0 :Text<span class="p">;</span>
    value @1 :Literal<span class="p">;</span>
  <span class="o">}</span>

  <span class="c1"># needs to be an interface</span>
  struct Array <span class="o">{</span>
    data @0 :Data<span class="p">;</span>
    shape @1 :List<span class="o">(</span>UInt32<span class="o">)</span><span class="p">;</span>
    dtype @2 :Text<span class="p">;</span>

  <span class="o">}</span>

  interface Function <span class="o">{</span>
    <span class="c1"># A pythonic function f(*args, **kwargs)</span>
    call @0 <span class="o">(</span>args :List<span class="o">(</span>Literal<span class="o">)</span>, kwargs :List<span class="o">(</span>Argument<span class="o">))</span> -&gt; <span class="o">(</span>result: Literal<span class="o">)</span><span class="p">;</span>
    getArgs @1 <span class="o">()</span> -&gt; <span class="o">(</span>args :List<span class="o">(</span>Text<span class="o">))</span><span class="p">;</span>
    getKwargs @2 <span class="o">()</span> -&gt; <span class="o">(</span>kwargs: List<span class="o">(</span>Argument<span class="o">))</span><span class="p">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>

<p>The above spec allows a Kamodo client (or server) to be implemented in many languages, including <a href="https://capnproto.org/cxx.html">C++</a>, C# (.NET Core), Erlang, Go, Haskell, JavaScript, OCaml, and Rust.</p>
<p>Further reading on capnproto may be found here: </p>
<ul>
<li><a href="https://capnproto.org/index.html">Overview</a></li>
<li><a href="https://capnproto.org/language.html">Schema language</a></li>
<li><a href="https://capnproto.org/rpc.html">RPC</a></li>
<li>Python implementation - <a href="http://capnproto.github.io/pycapnp/quickstart.html">pycapnp</a></li>
</ul>
<!-- #endregion -->
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../API/" class="btn btn-neutral float-right" title="API">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../notebooks/FieldIntegration/" class="btn btn-neutral" title="Field Integration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../notebooks/FieldIntegration/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../API/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
